ğŸ‘ é‡éš¾ç‚¹ï¼š
1. å…¨æ ˆé¡¹ç›®æ¶æ„
2. Kafka + Clickhouse + Flink å®æ—¶æ•°æ®æµç»å…¸æ¶æ„è®¾è®¡
3. æ€§èƒ½ä¸å¼‚å¸¸æŒ‡æ ‡é‡‡é›†

- ã€åˆä¸­çº§ã€‘åšè¿‡ç›‘æ§è®¾è®¡ï¼Ÿé‚£æ€§èƒ½ä¸å¼‚å¸¸ç›‘æ§æŒ‡æ ‡æ€ä¹ˆç®—çš„ï¼Ÿ
- ã€ä¸­é«˜çº§ã€‘æœ‰è®¾è®¡è¿‡å¤§å‹å®æ—¶æ•°æ®æµç›¸å…³ç³»ç»Ÿå—ï¼Œå…·ä½“æ€ä¹ˆåšï¼Ÿ
- ã€ä¸“å®¶çº§ã€‘è¯¦ç»†è¯´æ˜ç›‘æ§å¹³å°æ–¹æ¡ˆè®¾è®¡ä¸è½åœ°ï¼Œé¡¹ç›®å®è·µ

### ã€åˆä¸­çº§ã€‘åšè¿‡ç›‘æ§è®¾è®¡ï¼Ÿé‚£å‰ç«¯æ€§èƒ½ä¸å¼‚å¸¸ç›‘æ§æŒ‡æ ‡æ€ä¹ˆç®—ï¼Ÿ
æ€§èƒ½ç›‘æ§é‚£èŠ‚ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº†æ€§èƒ½ä¼˜åŒ–ç›¸å…³æŒ‡æ ‡æ¦‚å¿µï¼Œè¿™æ¬¡æˆ‘ä»¬æ¥ç»“åˆå¤§å‚ç›‘æ§å¹³å°å®æˆ˜ï¼Œå……åˆ†ç†è§£æŒ‡æ ‡å®šä¹‰ã€è®¡ç®—ä¸ä¸ŠæŠ¥é€»è¾‘ã€‚

å‰ç«¯æ€§èƒ½ç›‘æ§é€šè¿‡æ”¶é›†å’Œåˆ†æç”¨æˆ·ç«¯çš„æ€§èƒ½æ•°æ®æ¥è¡¡é‡å’Œä¼˜åŒ–é¡µé¢åŠ è½½é€Ÿåº¦ã€äº¤äº’å“åº”æ—¶é—´ç­‰å…³é”®æ€§èƒ½æŒ‡æ ‡çš„è¿‡ç¨‹ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦æ€§èƒ½ç›‘æ§ï¼Ÿ
- æå‡ç”¨æˆ·ä½“éªŒï¼šå‡å°‘é¡µé¢åŠ è½½å’Œå“åº”æ—¶é—´ï¼Œæé«˜ç”¨æˆ·ç•™å­˜ç‡ã€‚
- å‘ç°å’Œä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆï¼šåŠæ—¶å‘ç°å½±å“æ€§èƒ½çš„å› ç´ å¹¶è¿›è¡Œä¼˜åŒ–ã€‚
- æ•°æ®é©±åŠ¨å†³ç­–ï¼šåŸºäºçœŸå®æ•°æ®è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œè€Œéä¾èµ–ç›´è§‰ã€‚

### å¸¸è§çš„æ€§èƒ½ç›‘æ§æŒ‡æ ‡
#### é¡µé¢åŠ è½½æ—¶é—´ï¼ˆPage Load Timeï¼‰
- å®šä¹‰ï¼šä»ç”¨æˆ·å‘å‡ºè¯·æ±‚åˆ°é¡µé¢å®Œå…¨åŠ è½½å®Œæˆçš„æ—¶é—´ã€‚
- è®¡ç®—æ–¹å¼ï¼š
### ä»£ç å—
```javascript
const pageLoadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
```
- æ„ä¹‰ï¼šé¡µé¢åŠ è½½æ—¶é—´æ˜¯ç”¨æˆ·ä½“éªŒçš„æ ¸å¿ƒæŒ‡æ ‡ä¹‹ä¸€ã€‚

#### é¦–æ¬¡å†…å®¹ç»˜åˆ¶æ—¶é—´ï¼ˆFirst Contentful Paint, FCPï¼‰
- å®šä¹‰ï¼šé¡µé¢é¦–æ¬¡ç»˜åˆ¶å‡ºä»»ä½•å†…å®¹çš„æ—¶é—´ã€‚
- è·å–æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
new PerformanceObserver((entryList) => {
    const entries = entryList.getEntriesByName('first-contentful-paint');
    if (entries.length > 0) {
        const fcpTime = entries[0].startTime;
        console.log(`FCP: ${fcpTime}`);
    }
}).observe({ type: 'paint', buffered: true });
```
- æ„ä¹‰ï¼šFCPç›´æ¥åæ˜ é¡µé¢å¼€å§‹å±•ç°å†…å®¹çš„é€Ÿåº¦ã€‚

#### æœ€å¤§å†…å®¹ç»˜åˆ¶æ—¶é—´ï¼ˆLargest Contentful Paint, LCPï¼‰
- å®šä¹‰ï¼šé¡µé¢ä¸­æœ€å¤§å†…å®¹å…ƒç´ çš„æ¸²æŸ“æ—¶é—´ã€‚
- è·å–æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
new PerformanceObserver((entryList) => {
    const entries = entryList.getEntries();
    const lastEntry = entries[entries.length - 1];
    const lcpTime = lastEntry.startTime;
    console.log(`LCP: ${lcpTime}`);
}).observe({ type: 'largest-contentful-paint', buffered: true });
```
- æ„ä¹‰ï¼šLCPæ˜¯è¡¡é‡é¡µé¢ä¸»è¦å†…å®¹æ˜¯å¦è¿…é€ŸåŠ è½½çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚ 
  
#### äº¤äº’æ—¶é—´ï¼ˆTime to Interactive, TTIï¼‰
- å®šä¹‰ï¼šé¡µé¢ä»åŠ è½½å¼€å§‹åˆ°å¯ä»¥å“åº”ç”¨æˆ·äº¤äº’çš„æ—¶é—´ã€‚
- è®¡ç®—æ–¹å¼ï¼š
### ä»£ç å—
```javascript
const timeToInteractive = performance.timing.domInteractive - performance.timing.navigationStart;
```
- æ„ä¹‰ï¼šTTIç›´æ¥å…³ç³»åˆ°ç”¨æˆ·èƒ½å¤Ÿå¼€å§‹æ“ä½œé¡µé¢çš„æ—¶é—´ã€‚

#### èµ„æºåŠ è½½æ—¶é—´
- å®šä¹‰ï¼šæ¯ä¸ªé™æ€èµ„æºï¼ˆå¦‚å›¾ç‰‡ã€JSæ–‡ä»¶ï¼‰çš„åŠ è½½æ—¶é—´ã€‚
- è·å–æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
const resources = performance.getEntriesByType('resource');
resources.forEach((resource) => {
    const loadTime = resource.responseEnd - resource.startTime;
    console.log(`${resource.name}: ${loadTime}`);
});
```
- æ„ä¹‰ï¼šèµ„æºåŠ è½½æ—¶é—´å½±å“æ•´ä½“é¡µé¢åŠ è½½æ€§èƒ½ï¼Œæ˜¯ä¼˜åŒ–çš„å…³é”®ã€‚

### å‰ç«¯å¼‚å¸¸ç›‘æ§
å‰ç«¯å¼‚å¸¸ç›‘æ§æŒ‡çš„æ˜¯æ•è·å¹¶æŠ¥å‘Šç”¨æˆ·ç«¯å‘ç”Ÿçš„é”™è¯¯æˆ–å¼‚å¸¸ï¼Œå¸®åŠ©å¼€å‘è€…åŠæ—¶å‘ç°å’Œä¿®å¤é—®é¢˜ã€‚æœ€ç»å…¸çš„è¦æ•°sentryäº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å‘¢ï¼Œé‡ç‚¹äº†è§£sentryçš„æºç å®ç°ã€‚

#### JavaScripté”™è¯¯ï¼ˆJS Errorsï¼‰
- å®šä¹‰ï¼šè¿è¡Œæ—¶JavaScripté”™è¯¯ã€‚
- æ•è·æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
window.onerror = function (message, source, lineno, colno, error) {
    console.log(`Error: ${message}, Source: ${source}, Line: ${lineno}, Column: ${colno}, Error Object: ${error}`);
};
``` 

#### Promiseæœªå¤„ç†æ‹’ç»ï¼ˆUnhandled Promise Rejectionï¼‰
- å®šä¹‰ï¼šæœªå¤„ç†çš„Promiseæ‹’ç»é”™è¯¯ã€‚
- æ•è·æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
window.addEventListener('unhandledrejection', function (event) {
    console.log(`Unhandled Rejection: ${event.reason}`);
});
```

#### èµ„æºåŠ è½½é”™è¯¯
- å®šä¹‰ï¼šé™æ€èµ„æºåŠ è½½å¤±è´¥é”™è¯¯ã€‚
- æ•è·æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
window.addEventListener('error', function (event) {
    if (event.target!== window) {
        console.log(`Resource Load Error: ${event.target.src || event.target.href}`);
    }
}, true);
```

#### æ¥å£è¯·æ±‚å¤±è´¥ï¼ˆAPI Failureï¼‰
- å®šä¹‰ï¼šAPIè¯·æ±‚å¤±è´¥æˆ–è¶…æ—¶é”™è¯¯ã€‚
- æ•è·æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
fetch(url)
   .then(response => {
        if (!response.ok) {
            console.error(`API Failure: ${response.status} ${response.statusText}`);
        }
    })
   .catch(error => console.error(`Fetch Error: ${error}`));
```

### ç»Ÿä¸€ä¸ŠæŠ¥æ•°æ®æ ¼å¼
#### æ•°æ®æ ¼å¼è®¾è®¡åŸåˆ™
- ä¸€è‡´æ€§ï¼šæ‰€æœ‰ç›‘æ§æ•°æ®åº”é‡‡ç”¨ç»Ÿä¸€çš„æ ¼å¼ï¼Œä¾¿äºåç»­åˆ†æå’Œå±•ç¤ºã€‚
- å¯æ‰©å±•æ€§ï¼šæ•°æ®æ ¼å¼è®¾è®¡åº”è€ƒè™‘æœªæ¥çš„æ‰©å±•éœ€æ±‚ï¼Œå…è®¸æ·»åŠ æ–°å­—æ®µã€‚
- è½»é‡åŒ–ï¼šæ•°æ®å°½é‡ç²¾ç®€ï¼Œå‡å°‘ä¸ŠæŠ¥å¸¦æ¥çš„æ€§èƒ½å½±å“ã€‚ 

### æ•°æ®æ ¼å¼ç¤ºä¾‹
ä»¥ä¸‹ä¸ºä¸€ä¸ªä»¿ç…§Sentryå®šä¹‰çš„ç»Ÿä¸€æ€§èƒ½ä¸å¼‚å¸¸ç›‘æ§æ•°æ®æ ¼å¼ï¼š
### ä»£ç å—
```json
{
    "event_id": "unique-event-id",
    "timestamp": "2024-08-28T14:25:43.511Z",
    "platform": "javascript",
    "release": "project-release-version",
    "environment": "production",
    "user": {
        "id": "user-id",
        "username": "username",
        "email": "user@example.com",
        "ip_address": "user-ip-address"
    },
    "contexts": {
        "performance": {
            "page_load_time": 1234,
            "fcp": 678,
            "lcp": 1234,
            "tti": 2345,
            "resources": [
                {"name": "resource1.js", "load_time": 123},
                {"name": "image1.png", "load_time": 456}
            ]
        }
    },
    "exception": {
        "values": [
            {
                "type": "TypeError",
                "value": "Cannot read property 'x' of undefined",
                "stacktrace": {
                    "frames": [
                        {
                            "filename": "https://example.com/script.js",
                            "lineno": 42,
                            "colno": 21,
                            "function": "myFunction",
                            "in_app": true
                        }
                    ]
                }
            }
        ]
    },
    "errors": [
        {
            "message": "Unhandled Promise Rejection: Error: Something went wrong",
            "source": "https://example.com/promise.js",
            "lineno": 10,
            "colno": 15,
            "errorObject": {
                "name": "Error",
                "message": "Something went wrong",
                "stack": "Error: Something went wrong\n at promise.js:10:15"
            }
        },
        {
            "message": "Resource Load Error: https://example.com/image.png",
            "source": "image.png",
            "lineno": 0,
            "colno": 0
        }
    ],
    "breadcrumbs": [
        {
            "category": "ui.click",
            "message": "User clicked button",
            "level": "info",
            "timestamp": "2024-08-28T14:25:40.511Z"
        },
        {
            "category": "navigation",
            "message": "User navigated to /dashboard",
            "level": "info",
            "timestamp": "2024-08-28T14:25:43.511Z"
        }
    ]
}
``` 

### æ•°æ®ä¸ŠæŠ¥
ä½¿ç”¨ä»¥ä¸‹ä»£ç ä¸ŠæŠ¥ç›‘æ§æ•°æ®ï¼š
#### fetch
### ä»£ç å—
```javascript
fetch('https://your-monitoring-service.com/api/events', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer your-api-key'
    },
    body: JSON.stringify(eventData) // eventData æ˜¯ JSON æ•°æ®
});
```

é™¤æ­¤ä»¥å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹ä¸ŠæŠ¥æ–¹å¼ï¼š
- ajax
- å›¾ç‰‡æ‰“ç‚¹image
- navigator.sendBeacon
- WS

### ã€æ‹“å±•ã€‘ç”¨æˆ·è¡Œä¸ºåŸ‹ç‚¹ä¸ç›‘æ§
åŸ‹ç‚¹æ˜¯ä¸€ç§é€šè¿‡åœ¨å‰ç«¯ä»£ç ä¸­æ·»åŠ ç‰¹å®šæ ‡è®°æˆ–é€»è¾‘æ¥è®°å½•ç”¨æˆ·è¡Œä¸ºã€é¡µé¢äº‹ä»¶ç­‰æ•°æ®çš„æŠ€æœ¯ã€‚åŸ‹ç‚¹æ•°æ®å¯ä»¥å¸®åŠ©å¼€å‘è€…äº†è§£ç”¨æˆ·è¡Œä¸ºè·¯å¾„ã€é¡µé¢åŠŸèƒ½ä½¿ç”¨æƒ…å†µç­‰ï¼Œä¸ºäº§å“ä¼˜åŒ–å’Œç”¨æˆ·ä½“éªŒæå‡æä¾›æ•°æ®æ”¯æŒã€‚

### å¸¸è§åŸ‹ç‚¹æŒ‡æ ‡
1. **é¡µé¢æµè§ˆé‡ï¼ˆPage View, PVï¼‰**
    - å®šä¹‰ï¼šç”¨æˆ·æ¯æ¬¡åŠ è½½é¡µé¢æ—¶çš„è®¡æ•°ã€‚
    - åŸ‹ç‚¹æ–¹å¼ï¼šåœ¨é¡µé¢åŠ è½½æ—¶è§¦å‘åŸ‹ç‚¹ã€‚
### ä»£ç å—
```javascript
// Example: åŸ‹ç‚¹è§¦å‘
sendTrackingData({
    event: 'page_view',
    url: window.location.href,
    timestamp: Date.now()
});
```
2. **ç‹¬ç«‹è®¿å®¢æ•°ï¼ˆUnique Visitor, UVï¼‰**
    - å®šä¹‰ï¼šç‹¬ç«‹ç”¨æˆ·è®¿é—®æ¬¡æ•°çš„è®¡æ•°ã€‚é€šå¸¸é€šè¿‡ç”¨æˆ·IDæˆ–Cookieè¿›è¡Œè¯†åˆ«ã€‚
    - åŸ‹ç‚¹æ–¹å¼ï¼šåœ¨ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ—¶è§¦å‘åŸ‹ç‚¹ã€‚
### ä»£ç å—
```javascript
// Example: è·å–ç”¨æˆ·IDå¹¶è§¦å‘UVåŸ‹ç‚¹
const userId = getUserIdFromCookie();
if (!userId) {
    setUserIdInCookie(generateNewUserId());
}
sendTrackingData({
    event: 'unique_visitor',
    userId: userId,
    timestamp: Date.now()
});
```
3. **ç‚¹å‡»äº‹ä»¶ï¼ˆClick Eventï¼‰**
    - å®šä¹‰ï¼šç”¨æˆ·ç‚¹å‡»é¡µé¢å…ƒç´ ï¼ˆå¦‚æŒ‰é’®ã€é“¾æ¥ï¼‰æ—¶çš„è®°å½•ã€‚
    - åŸ‹ç‚¹æ–¹å¼ï¼šåœ¨ç”¨æˆ·ç‚¹å‡»ç‰¹å®šå…ƒç´ æ—¶è§¦å‘åŸ‹ç‚¹ã€‚
### ä»£ç å—
```javascript
document.getElementById('buttonId').addEventListener('click', function() {
    sendTrackingData({
        event: 'click',
        elementId: 'buttonId',
        url: window.location.href,
        timestamp: Date.now()
    });
});
```
4. **è¡¨å•æäº¤ï¼ˆForm Submitï¼‰**
    - å®šä¹‰ï¼šç”¨æˆ·æäº¤è¡¨å•æ—¶çš„è®°å½•ã€‚
    - åŸ‹ç‚¹æ–¹å¼ï¼šåœ¨è¡¨å•æäº¤æ—¶è§¦å‘åŸ‹ç‚¹ã€‚
### ä»£ç å—
```javascript
document.getElementById('formId').addEventListener('submit', function() {
    sendTrackingData({
        event: 'form_submit',
        formId: 'formId',
        url: window.location.href,
        timestamp: Date.now()
    });
});
```
5. **åœç•™æ—¶é—´ï¼ˆTime on Pageï¼‰**
    - å®šä¹‰ï¼šç”¨æˆ·åœ¨é¡µé¢ä¸Šåœç•™çš„æ—¶é—´ã€‚
    - åŸ‹ç‚¹æ–¹å¼ï¼šåœ¨é¡µé¢åŠ è½½å’Œå…³é—­æ—¶åˆ†åˆ«è§¦å‘åŸ‹ç‚¹ï¼Œå¹¶è®¡ç®—æ—¶é—´å·®ã€‚
### ä»£ç å—
```javascript
const startTime = Date.now();
window.addEventListener('beforeunload', function() {
    const timeSpent = Date.now() - startTime;
    sendTrackingData({
        event: 'time_on_page',
        timeSpent: timeSpent,
        url: window.location.href,
        timestamp: Date.now()
    });
});
``` 

### ç»¼åˆåŸ‹ç‚¹æ•°æ®åè®®è®¾è®¡
åœ¨ä¹‹å‰çš„æ€§èƒ½ä¸å¼‚å¸¸ç›‘æ§æ•°æ®æ ¼å¼çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åŠ å…¥åŸ‹ç‚¹æ•°æ®ï¼Œä½¿æ•°æ®åè®®æ›´åŠ å®Œæ•´å’Œçµæ´»ã€‚ä»¥ä¸‹æ˜¯åŒ…å«åŸ‹ç‚¹ä¿¡æ¯çš„ç»¼åˆæ•°æ®åè®®è®¾è®¡ï¼š
### ä»£ç å—
```json
{
    "event_id": "unique-event-id",
    "timestamp": "2024-08-28T14:25:43.511Z",
    "platform": "javascript",
    "release": "project-release-version",
    "environment": "production",
    "user": {
        "id": "user-id",
        "username": "username",
        "email": "user@example.com",
        "ip_address": "user-ip-address"
    },
    "contexts": {
        "performance": {
            "page_load_time": 1234,
            "fcp": 678,
            "lcp": 1234,
            "tti": 2345,
            "resources": [
                {"name": "resource1.js", "load_time": 123},
                {"name": "image1.png", "load_time": 456}
            ]
        },
        "exceptions": {
            "values": [
                {
                    "type": "TypeError",
                    "value": "Cannot read property 'x' of undefined",
                    "stacktrace": {
                        "frames": [
                            {
                                "filename": "https://example.com/script.js",
                                "lineno": 42,
                                "colno": 21,
                                "function": "myFunction",
                                "in_app": true
                            }
                        ]
                    }
                }
            ]
        }
    },
    "tracking": {
        "events": [
            {
                "event": "page_view",
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:25:43.511Z"
            },
            {
                "event": "click",
                "elementId": "buttonId",
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:26:00.511Z"
            },
            {
                "event": "form_submit",
                "formId": "formId",
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:26:30.511Z"
            },
            {
                "event": "time_on_page",
                "timeSpent": 120000,
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:28:00.511Z"
            }
        ]
    },
    "errors": [
        {
            "message": "Unhandled Promise Rejection: Error: Something went wrong",
            "source": "https://example.com/promise.js",
            "lineno": 10,
            "colno": 15,
            "errorObject": {
                "name": "Error",
                "message": "Something went wrong",
                "stack": "Error: Something went wrong\n at promise.js:10:15"
            }
        },
        {
            "message": "Resource Load Error: https://example.com/image.png",
            "source": "image.png",
            "lineno": 0,
            "colno": 0
        }
    ],
    "breadcrumbs": [
        {
            "category": "ui.click",
            "message": "User clicked button",
            "level": "info",
            "timestamp": "2024-08-28T14:25:40.511Z"
        },
        {
            "category": "navigation",
            "message": "User navigated to /dashboard",
            "level": "info",
            "timestamp": "2024-08-28T14:25:43.511Z"
        }
    ]
}
``` 

### ã€ä¸­é«˜çº§ã€‘æœ‰è®¾è®¡è¿‡å¤§å‹å®æ—¶æ•°æ®æµç›¸å…³ç³»ç»Ÿå—ï¼Œå…·ä½“æ€ä¹ˆåšï¼Ÿ
æˆ‘è®¾è®¡è¿‡å‰ç«¯ç›‘æ§å¹³å°æ•°æ®ä¸ŠæŠ¥ã€æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†ï¼ˆKafkaï¼‰ç›´è‡³æ•°æ®è½åº“ClickHouseå®Œæ•´ç¯èŠ‚ã€‚
å…¶ä¸­å®Œæ•´ç»†èŠ‚åŒ…æ‹¬ï¼š
1. ç›‘æ§æ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥
2. æ•°æ®æ¥æ”¶ä¸æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafkaï¼‰æœºåˆ¶
3. æ•°æ®é¢„å¤„ç†ï¼ˆFlink/Sparkï¼‰
4. æ•°æ®å­˜å‚¨ï¼ˆClickHouseï¼‰
5. å‰ç«¯æ•°æ®å¯è§†åŒ–ä¸é¢„è­¦æœºåˆ¶

### å‰ç«¯ç›‘æ§æ•°æ®ä¸ŠæŠ¥
#### æ•°æ®æ”¶é›†æ–¹å¼
åœ¨å‰ç«¯ï¼Œæˆ‘ä»¬éœ€è¦é‡‡é›†ç”¨æˆ·è¡Œä¸ºã€æ€§èƒ½æŒ‡æ ‡ã€å¼‚å¸¸æ—¥å¿—ç­‰ç›‘æ§æ•°æ®ã€‚è¿™äº›æ•°æ®å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ”¶é›†ï¼š
- AJAXè¯·æ±‚ï¼šé€šè¿‡fetchæˆ–XMLHttpRequestå‘é€æ•°æ®è‡³åç«¯ã€‚
- sendBeaconï¼šç”¨äºåœ¨é¡µé¢å¸è½½æˆ–å…³é—­æ—¶ä¸ŠæŠ¥æ•°æ®ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±ã€‚
- WebSocketï¼šç”¨äºå®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„æ•°æ®ä¸ŠæŠ¥ï¼Œä¿æŒå‰ç«¯å’Œåç«¯çš„é•¿è¿æ¥ã€‚

#### æ•°æ®ç»“æ„è®¾è®¡
ä¸ŠæŠ¥çš„æ•°æ®é€šå¸¸åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
- äº‹ä»¶ç±»å‹ï¼šå¦‚clickã€errorã€performanceç­‰ã€‚
- æ—¶é—´æˆ³ï¼šäº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ï¼Œç”¨äºæ’åºå’Œåˆ†æã€‚
- ç”¨æˆ·ä¿¡æ¯ï¼šåŒ…æ‹¬ç”¨æˆ·IDã€ä¼šè¯IDã€è®¾å¤‡ä¿¡æ¯ç­‰ã€‚
- é¡µé¢ä¿¡æ¯ï¼šåŒ…æ‹¬é¡µé¢URLã€é¡µé¢åŠ è½½æ—¶é—´ç­‰æ€§èƒ½æŒ‡æ ‡ã€‚

### ç¤ºä¾‹JSONæ•°æ®ç»“æ„
### ä»£ç å—
```json
{
    "event_type": "click",
    "timestamp": "2024-08-28T14:25:43.511Z",
    "user": {
        "id": "user-id",
        "session_id": "session-id",
        "device": "device-info"
    },
    "page": {
        "url": "https://example.com",
        "referrer": "https://referrer.com"
    },
    "data": {
        "element_id": "buttonId",
        "x_position": 100,
        "y_position": 200
    }
}
```

#### æ•°æ®ä¸ŠæŠ¥åˆ°åç«¯
å‰ç«¯é€šè¿‡ä¸Šè¿°æ–¹å¼æ”¶é›†æ•°æ®åï¼Œå°†è¿™äº›æ•°æ®å‘é€åˆ°åç«¯çš„APIæ¥å£æˆ–Kafkaä¸»é¢˜ä¸­ã€‚
### ä»£ç å—
```javascript
fetch('https://your-server.com/api/monitoring', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(eventData)
});
```

### æ•°æ®æ¥æ”¶ä¸é˜Ÿåˆ—å¤„ç†
#### æ¥æ”¶å±‚ï¼šNginxæˆ–Node.js
åç«¯APIè´Ÿè´£æ¥æ”¶å‰ç«¯å‘é€çš„ç›‘æ§æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨Nginxè¿›è¡Œè´Ÿè½½å‡è¡¡å’Œåå‘ä»£ç†ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°å¤šä¸ªNode.jsæœåŠ¡å™¨ï¼Œç¡®ä¿ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ã€‚
- Nginxåå‘ä»£ç†ï¼šNginxè´Ÿè´£åˆ†å‘è¯·æ±‚ï¼Œæ”¯æŒé«˜å¹¶å‘ï¼Œé€‚åˆå¤§è§„æ¨¡æ•°æ®æ¥å…¥ã€‚
- Node.jsæœåŠ¡å™¨ï¼šNode.jsæä¾›çµæ´»çš„APIæ¥å£ï¼Œå¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®ã€‚

#### æ•°æ®é˜Ÿåˆ—ï¼šKafka
æ¥æ”¶åˆ°çš„æ•°æ®é€šå¸¸ç›´æ¥æ¨é€åˆ°Kafkaé˜Ÿåˆ—ä¸­è¿›è¡Œç¼“å†²å¤„ç†ï¼Œè¿™æ ·å¯ä»¥è§£è€¦æ•°æ®æ¥æ”¶ä¸åç»­çš„å¤„ç†é€»è¾‘ã€‚

#### Kafkaçš„ä½œç”¨
- é«˜ååé‡ï¼šKafkaå¯ä»¥å¤„ç†å¤§é‡çš„ç›‘æ§æ•°æ®ï¼Œç¡®ä¿æ•°æ®çš„å®æ—¶æ€§ã€‚
- æ•°æ®æŒä¹…åŒ–ï¼šKafkaä¼šå°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œç¡®ä¿åœ¨æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ä¹‹å‰æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚
- å¤šæ¶ˆè´¹è€…å¤„ç†ï¼šKafkaæ”¯æŒå¤šä¸ªæ¶ˆè´¹è€…ç»„ï¼Œè¿™å…è®¸æˆ‘ä»¬å¯¹ä¸åŒç±»å‹çš„æ•°æ®è¿›è¡Œå¹¶è¡Œå¤„ç†ã€‚

#### Kafkaä¸»é¢˜ä¸åˆ†åŒº
- ä¸»é¢˜ï¼šå¯ä»¥æ ¹æ®æ•°æ®ç±»å‹ï¼ˆå¦‚æ€§èƒ½æ•°æ®ã€é”™è¯¯æ•°æ®ã€ç”¨æˆ·è¡Œä¸ºæ•°æ®ç­‰ï¼‰åˆ›å»ºä¸åŒçš„Kafkaä¸»é¢˜ï¼Œç¡®ä¿æ•°æ®åˆ†ç±»å¤„ç†ã€‚
- åˆ†åŒºï¼šKafkaçš„åˆ†åŒºæœºåˆ¶å…è®¸æˆ‘ä»¬å°†åŒä¸€ä¸»é¢˜çš„æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªåˆ†åŒºä¸Šï¼Œæå‡å¤„ç†æ€§èƒ½ã€‚
### ä»£ç å—
```javascript
const kafka = require('kafka-node');
const client = new kafka.KafkaClient({kafkaHost: 'localhost:9092'});
const producer = new kafka.Producer(client);

const payloads = [
    { topic:'monitoring', messages: JSON.stringify(eventData), partition: 0 }
];

producer.send(payloads, function(err, data) {
    console.log(data);
});
``` 

### æ•°æ®å¤„ç†ä¸é¢„å¤„ç†
#### Kafka Consumer
Kafkaçš„æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­æ‹‰å–æ•°æ®ï¼Œå¯¹æ•°æ®è¿›è¡Œæ¸…æ´—ã€è¿‡æ»¤ã€èšåˆç­‰é¢„å¤„ç†æ“ä½œã€‚
- æ•°æ®æ¸…æ´—ï¼šè¿‡æ»¤æ‰æ— æ•ˆæˆ–é‡å¤çš„æ•°æ®ï¼Œç¡®ä¿æ•°æ®çš„å‡†ç¡®æ€§ã€‚
- æ•°æ®èšåˆï¼šåœ¨æ¶ˆè´¹è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å¯¹æ•°æ®è¿›è¡Œåˆæ­¥çš„èšåˆï¼Œå¦‚æŒ‰ç”¨æˆ·IDèšåˆè®¿é—®æ¬¡æ•°ç­‰ã€‚
- å®æ—¶å¤„ç†ï¼šæ¶ˆè´¹è€…å¯ä»¥å°†æ•°æ®å®æ—¶å¤„ç†åæ¨é€åˆ°ClickHouseï¼Œä¹Ÿå¯ä»¥è¿›ä¸€æ­¥æ¨é€åˆ°å…¶ä»–å¤„ç†å±‚ï¼ˆå¦‚Sparkã€Flinkï¼‰è¿›è¡Œæ›´å¤æ‚çš„å®æ—¶åˆ†æã€‚
### ä»£ç å—
```javascript
const Consumer = kafka.Consumer;
const consumer = new Consumer(client, [{ topic:'monitoring', partition: 0 }], {autoCommit: true});

consumer.on('message', function(message) {
    const data = JSON.parse(message.value);
    processData(data); // æ•°æ®é¢„å¤„ç†é€»è¾‘
});
``` 

### æ•°æ®å¤„ç†å±‚ï¼šæµå¼å¤„ç†
å¯ä»¥ä½¿ç”¨æµå¼å¤„ç†å¼•æ“ï¼ˆå¦‚Apache Flinkæˆ–Spark Streamingï¼‰æ¥å¤„ç†å’Œåˆ†æä»Kafkaæ¶ˆè´¹çš„æ•°æ®æµã€‚
- Apache Flinkï¼šFlinkæä¾›äº†ä½å»¶è¿Ÿçš„å®æ—¶æµå¤„ç†ï¼Œé€‚åˆå¤„ç†å¤æ‚çš„äº‹ä»¶æ¨¡å¼ã€‚
- Spark Streamingï¼šé€‚åˆæ‰¹å¤„ç†ä¸æµå¤„ç†ç»“åˆçš„åœºæ™¯ï¼Œèƒ½å¤Ÿå¤„ç†å¤§é‡æ•°æ®çš„åŒæ—¶è¿›è¡Œå¤æ‚åˆ†æã€‚

é€šè¿‡æµå¼å¤„ç†å¼•æ“ï¼Œç³»ç»Ÿèƒ½å¤Ÿåœ¨æ•°æ®è¿›å…¥å­˜å‚¨ä¹‹å‰æ‰§è¡Œå¤æ‚çš„æ•°æ®åˆ†ææˆ–äº‹ä»¶æ£€æµ‹ã€‚

### æ•°æ®å­˜å‚¨ï¼šClickHouse
#### æ•°æ®å†™å…¥ClickHouse
å¤„ç†åçš„æ•°æ®æœ€ç»ˆä¼šå†™å…¥ClickHouseæ•°æ®åº“ä¸­ï¼Œä»¥ä¾›æŸ¥è¯¢å’Œåˆ†æã€‚

#### ä¸ºä»€ä¹ˆé€‰æ‹©ClickHouse?
- é«˜æ€§èƒ½æŸ¥è¯¢ï¼šClickHouseé‡‡ç”¨åˆ—å¼å­˜å‚¨å’Œæ•°æ®å‹ç¼©æŠ€æœ¯ï¼Œèƒ½å¤Ÿåœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶æä¾›é«˜æ•ˆçš„æŸ¥è¯¢æ€§èƒ½ã€‚
- å®æ—¶åˆ†æï¼šClickHouseæ”¯æŒå®æ—¶æ•°æ®æ’å…¥å’ŒæŸ¥è¯¢ï¼Œé€‚åˆå®æ—¶ç›‘æ§ç³»ç»Ÿçš„éœ€æ±‚ã€‚
- åˆ†å¸ƒå¼æ¶æ„ï¼šClickHouseæ”¯æŒæ•°æ®çš„åˆ†å¸ƒå¼å­˜å‚¨å’ŒæŸ¥è¯¢ï¼Œèƒ½å¤Ÿè½»æ¾æ‰©å±•ä»¥å¤„ç†æ›´å¤§è§„æ¨¡çš„æ•°æ®ã€‚

### è¡¨ç»“æ„è®¾è®¡
ClickHouseçš„è¡¨ç»“æ„è®¾è®¡éœ€è¦è€ƒè™‘åˆ°æ•°æ®çš„æŸ¥è¯¢éœ€æ±‚å’Œæ€§èƒ½ä¼˜åŒ–ã€‚å¸¸è§çš„åšæ³•æ˜¯æ ¹æ®æ•°æ®çš„ç»´åº¦å’ŒæŒ‡æ ‡è®¾è®¡è¡¨ç»“æ„ï¼Œå¹¶åˆ›å»ºé€‚å½“çš„åˆ†åŒºå’Œç´¢å¼•ã€‚

### ç¤ºä¾‹è¡¨ç»“æ„
### ä»£ç å—
```sql
CREATE TABLE monitoring_data (
    event_type String,
    timestamp DateTime,
    user_id String,
    session_id String,
    device String,
    url String,
    referrer String,
    element_id String,
    x_position Int32,
    y_position Int32
) ENGINE = MergeTree()
ORDER BY (timestamp, event_type)
PARTITION BY toYYYYMM(timestamp)
```

- ORDER BYï¼šç”¨äºåŠ é€ŸæŸ¥è¯¢ï¼Œç‰¹åˆ«æ˜¯åœ¨æ—¶é—´èŒƒå›´æŸ¥è¯¢å’ŒæŒ‰äº‹ä»¶ç±»å‹æŸ¥è¯¢æ—¶æ€§èƒ½æå‡æ˜¾è‘—ã€‚
- PARTITION BYï¼šæŒ‰æœˆåˆ†åŒºï¼ˆæˆ–å…¶ä»–æ—¶é—´å‘¨æœŸï¼‰ï¼Œä»¥ä¼˜åŒ–å­˜å‚¨å’ŒæŸ¥è¯¢æ€§èƒ½ã€‚

### æ•°æ®æ’å…¥æ“ä½œ
æ•°æ®å¯ä»¥é€šè¿‡Kafkaæ¶ˆè´¹è€…æˆ–è€…ç›´æ¥ä»æµå¼å¤„ç†å¼•æ“æ¨é€åˆ°ClickHouseï¼Œè¿›è¡Œæ‰¹é‡æ’å…¥æ“ä½œï¼Œç¡®ä¿ç³»ç»Ÿçš„å†™å…¥æ€§èƒ½ã€‚
### ä»£ç å—
```python
import clickhouse_driver

client = clickhouse_driver.Client('localhost')

client.execute('INSERT INTO monitoring_data (event_type, timestamp, user_id, session_id, device, url, referrer, element_id, x_position, y_position) VALUES', data_batch)
```

### æ•°æ®æŸ¥è¯¢ä¸åˆ†æ
å­˜å‚¨åœ¨ClickHouseçš„æ•°æ®å¯ä»¥é€šè¿‡SQLæŸ¥è¯¢è¿›è¡Œåˆ†æï¼Œå‰ç«¯å¯ä»¥é€šè¿‡REST APIæˆ–è€…ç›´æ¥ä½¿ç”¨ClickHouseæä¾›çš„HTTPæ¥å£è¿›è¡Œæ•°æ®è·å–ã€‚ 

### ä»£ç å—
```sql
SELECT
    event_type,
    COUNT(*) AS event_count
FROM monitoring_data
WHERE timestamp >= now() - INTERVAL 1 HOUR
GROUP BY event_type
ORDER BY event_count DESC
```

### å‰ç«¯æ•°æ®å±•ç¤ºä¸æŠ¥è­¦
#### å‰ç«¯å±•ç¤º
å‰ç«¯å¯ä»¥é€šè¿‡è°ƒç”¨REST APIæˆ–è€…ç›´æ¥æŸ¥è¯¢ClickHouseæ•°æ®åº“ï¼Œè·å–éœ€è¦å±•ç¤ºçš„æ•°æ®ï¼Œå¹¶ä½¿ç”¨å›¾è¡¨åº“ï¼ˆå¦‚EChartsæˆ–D3.jsï¼‰è¿›è¡Œå¯è§†åŒ–å±•ç¤ºã€‚
- å®æ—¶ç›‘æ§é¢æ¿ï¼šé€šè¿‡WebSocketæˆ–å®šæ—¶åˆ·æ–°æœºåˆ¶ï¼Œå®æ—¶å±•ç¤ºç³»ç»Ÿçš„æ€§èƒ½æŒ‡æ ‡ã€é”™è¯¯ç‡ç­‰å…³é”®æ•°æ®ã€‚
- å†å²æ•°æ®åˆ†æï¼šé€šè¿‡æŸ¥è¯¢ClickHouseçš„å†å²æ•°æ®ï¼Œç”Ÿæˆè¶‹åŠ¿å›¾ã€åˆ†å¸ƒå›¾ç­‰ï¼Œå¸®åŠ©åˆ†æç³»ç»Ÿçš„é•¿æœŸè¡¨ç°ã€‚

#### æŠ¥è­¦æœºåˆ¶
åœ¨æ•°æ®åˆ†æçš„åŸºç¡€ä¸Šï¼Œå¯ä»¥è®¾ç½®é˜ˆå€¼æˆ–æ£€æµ‹å¼‚å¸¸æ¨¡å¼ï¼Œå½“æ•°æ®è¶…å‡ºé¢„è®¾èŒƒå›´æ—¶ï¼Œè§¦å‘æŠ¥è­¦ã€‚
- å®šæ—¶ä»»åŠ¡ï¼šå¯ä»¥å®šæœŸæŸ¥è¯¢ClickHouseæ•°æ®åº“ï¼Œæ£€æµ‹æ˜¯å¦æœ‰æŒ‡æ ‡è¶…å‡ºé¢„è­¦èŒƒå›´ã€‚
- å®æ—¶æŠ¥è­¦ï¼šé€šè¿‡æµå¼å¤„ç†ç³»ç»Ÿï¼ˆå¦‚Flinkï¼‰å®æ—¶æ£€æµ‹å¼‚å¸¸ï¼Œç›´æ¥è§¦å‘æŠ¥è­¦ï¼ˆå¦‚å‘é€é‚®ä»¶æˆ–æ¶ˆæ¯é€šçŸ¥ï¼‰ã€‚

### ã€ä¸“å®¶çº§å…¨æ ˆã€‘è¯¦ç»†è¯´æ˜ç›‘æ§å¹³å°æ–¹æ¡ˆè®¾è®¡ä¸è½åœ°ï¼Œé¡¹ç›®å®è·µ
#### æ•´ä½“æ¶æ„è®¾è®¡
##### æ¶æ„æ¦‚è¿°
ç›‘æ§å¹³å°çš„æ•´ä½“æ¶æ„åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªä¸»è¦æ¨¡å—ï¼š
1. å‰ç«¯ç›‘æ§æ•°æ®é‡‡é›†ï¼šå‰ç«¯åº”ç”¨é‡‡é›†ç”¨æˆ·è¡Œä¸ºã€æ€§èƒ½æŒ‡æ ‡ã€é”™è¯¯æ—¥å¿—ç­‰æ•°æ®ï¼Œå¹¶é€šè¿‡å¤šç§æ–¹å¼ä¸ŠæŠ¥è‡³åç«¯ã€‚
2. æœåŠ¡ç«¯æ•°æ®æ¥æ”¶ä¸å¤„ç†ï¼šæœåŠ¡ç«¯ä½¿ç”¨NestJSä½œä¸ºæ ¸å¿ƒæ¡†æ¶ï¼Œæ¥æ”¶å¹¶å¤„ç†å‰ç«¯ä¸ŠæŠ¥çš„æ•°æ®ï¼ŒåŒæ—¶å°†æ•°æ®æ¨é€è‡³Kafkaè¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚
3. æ•°æ®é˜Ÿåˆ—ä¸æµå¤„ç†ï¼šé€šè¿‡Kafkaè¿›è¡Œæ•°æ®ç¼“å†²å’Œæµå¼å¤„ç†ï¼Œç¡®ä¿æ•°æ®å¤„ç†çš„å®æ—¶æ€§å’Œé«˜ååé‡ã€‚
4. æ•°æ®å­˜å‚¨ä¸åˆ†æï¼šå¤„ç†åçš„æ•°æ®æœ€ç»ˆå­˜å‚¨åœ¨ClickHouseä¸­ï¼Œç”¨äºå®æ—¶æŸ¥è¯¢å’Œåˆ†æã€‚
5. å‰ç«¯å±•ç¤ºä¸æŠ¥è­¦ï¼šé€šè¿‡å¯è§†åŒ–ç•Œé¢å±•ç¤ºç›‘æ§æ•°æ®ï¼Œå¹¶åœ¨å¿…è¦æ—¶è§¦å‘æŠ¥è­¦æœºåˆ¶ã€‚

##### æŠ€æœ¯é€‰å‹
- å‰ç«¯ï¼šä½¿ç”¨JavaScript/TypeScriptç¼–å†™çš„SDKï¼Œè´Ÿè´£é‡‡é›†å’Œä¸ŠæŠ¥ç›‘æ§æ•°æ®ã€‚
- åç«¯ï¼šNestJSæ¡†æ¶ï¼Œä½¿ç”¨TypeScriptç¼–å†™ï¼Œæä¾›APIæ¥å£å’Œæ•°æ®å¤„ç†é€»è¾‘ã€‚
- æ•°æ®é˜Ÿåˆ—ï¼šKafkaï¼Œç”¨äºé«˜å¹¶å‘æ•°æ®çš„ç¼“å†²å’Œä¼ è¾“ã€‚
- æ•°æ®å­˜å‚¨ï¼šClickHouseï¼Œç”¨äºå­˜å‚¨å’Œå¿«é€ŸæŸ¥è¯¢å¤§è§„æ¨¡ç›‘æ§æ•°æ®ã€‚
- æµå¤„ç†ï¼šApache Flinkæˆ–Spark Streamingï¼Œç”¨äºå®æ—¶æ•°æ®å¤„ç†å’Œåˆ†æã€‚

#### å‰ç«¯æ¥å…¥
##### å‰ç«¯SDKè®¾è®¡
ä¸ºäº†è®©å‰ç«¯åº”ç”¨èƒ½å¤Ÿæ— ç¼æ¥å…¥ç›‘æ§å¹³å°ï¼Œéœ€è¦è®¾è®¡ä¸€ä¸ªå‰ç«¯SDKã€‚è¿™ä¸ªSDKåº”è¯¥å…·å¤‡ä»¥ä¸‹åŠŸèƒ½ï¼š
- è‡ªåŠ¨é‡‡é›†æ€§èƒ½æŒ‡æ ‡ï¼šåŒ…æ‹¬é¡µé¢åŠ è½½æ—¶é—´ã€FCPã€LCPã€TTIç­‰ã€‚
- æ•è·JavaScripté”™è¯¯ï¼šæ•è·è¿è¡Œæ—¶é”™è¯¯å’Œæœªå¤„ç†çš„Promiseæ‹’ç»ã€‚
- ç”¨æˆ·è¡Œä¸ºè¿½è¸ªï¼šå¦‚ç‚¹å‡»ã€è¡¨å•æäº¤ã€é¡µé¢åœç•™æ—¶é—´ç­‰ã€‚
- æ•°æ®ä¸ŠæŠ¥ï¼šé€šè¿‡fetchã€sendBeaconæˆ–WebSocketå°†æ•°æ®ä¸ŠæŠ¥åˆ°åç«¯ã€‚ 

### SDKå®ç°ç¤ºä¾‹
### ä»£ç å—
```typescript
class MonitoringSDK {
    private endpoint: string;

    constructor(endpoint: string) {
        this.endpoint = endpoint;
        this.init();
    }

    private init() {
        this.collectPerformanceData();
        this.setupErrorHandling();
    }

    private collectPerformanceData() {
        window.addEventListener('load', () => {
            const performanceData = {
                event_type: 'performance',
                timestamp: new Date().toISOString(),
                data: {
                    pageLoadTime: performance.timing.loadEventEnd - performance.timing.navigationStart,
                    fcp: performance.getEntriesByName('first-contentful-paint')[0]?.startTime || null,
                    lcp: performance.getEntriesByType('largest-contentful-paint')[0]?.startTime || null,
                    tti: performance.timing.domInteractive - performance.timing.navigationStart
                }
            };
            this.sendData(performanceData);
        });
    }

    private setupErrorHandling() {
        window.onerror = (message, source, lineno, colno, error) => {
            const errorData = {
                event_type: 'error',
                timestamp: new Date().toISOString(),
                data: {
                    message,
                    source,
                    lineno,
                    colno,
                    stack: error?.stack || ''
                }
            };
            this.sendData(errorData);
        };

        window.addEventListener('unhandledrejection', (event) => {
            const rejectionData = {
                event_type: 'unhandledrejection',
                timestamp: new Date().toISOString(),
                data: {
                    reason: event.reason,
                    stack: event.reason?.stack || ''
                }
            };
            this.sendData(rejectionData);
        });
    }

    private sendData(data: any) {
        navigator.sendBeacon(this.endpoint, JSON.stringify(data));
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const monitoring = new MonitoringSDK('https://your-server.com/api/monitoring');
``` 

### å‰ç«¯åº”ç”¨é›†æˆ
å°†SDKé›†æˆåˆ°å‰ç«¯åº”ç”¨ä¸­éå¸¸ç®€å•ã€‚å¼€å‘è€…åªéœ€åœ¨åº”ç”¨çš„å…¥å£æ–‡ä»¶ï¼ˆå¦‚index.jsæˆ–main.tsï¼‰ä¸­å¼•å…¥å¹¶åˆå§‹åŒ–SDKã€‚
### ä»£ç å—
```typescript
import MonitoringSDK from './monitoring-sdk';

// åˆå§‹åŒ–SDK
const monitoring = new MonitoringSDK('https://your-server.com/api/monitoring');
```
é›†æˆåï¼Œå‰ç«¯åº”ç”¨åœ¨ç”¨æˆ·è®¿é—®é¡µé¢æ—¶ä¼šè‡ªåŠ¨å¼€å§‹é‡‡é›†å’Œä¸ŠæŠ¥æ•°æ®ï¼Œè€Œå¼€å‘è€…å‡ ä¹ä¸éœ€è¦åšé¢å¤–çš„å·¥ä½œã€‚

### æœåŠ¡ç«¯å®ç°ï¼ˆNestJSï¼‰
#### NestJSæœåŠ¡ç«¯æ¶æ„
NestJSæ˜¯ä¸€ä¸ªåŸºäºNode.jsçš„ç°ä»£Webæ¡†æ¶ï¼Œé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œéå¸¸é€‚åˆæ„å»ºå¤æ‚çš„ä¼ä¸šçº§åº”ç”¨ã€‚åœ¨ç›‘æ§å¹³å°çš„æœåŠ¡ç«¯å®ç°ä¸­ï¼Œæˆ‘ä»¬å°†NestJSç”¨äºä»¥ä¸‹å‡ ä¸ªå…³é”®éƒ¨åˆ†ï¼š
- APIæ¥å£ï¼šæä¾›æ•°æ®æ¥æ”¶æ¥å£ï¼Œå¤„ç†å‰ç«¯ä¸ŠæŠ¥çš„æ•°æ®ã€‚
- æ•°æ®å¤„ç†ä¸è½¬å‘ï¼šå¤„ç†å¹¶æ¸…æ´—æ•°æ®ï¼Œç„¶åæ¨é€è‡³Kafkaè¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚
- ä¸æ•°æ®åº“çš„äº¤äº’ï¼šåœ¨å¿…è¦æ—¶ç›´æ¥ä¸ClickHouseè¿›è¡Œäº¤äº’ï¼Œæ‰§è¡Œæ•°æ®æŸ¥è¯¢ã€‚

#### å®ç°æ•°æ®æ¥æ”¶ä¸å¤„ç†
##### æ•°æ®æ¥æ”¶æ¨¡å—
é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ§åˆ¶å™¨ï¼ˆControllerï¼‰ï¼Œç”¨äºæ¥æ”¶å‰ç«¯ä¸ŠæŠ¥çš„æ•°æ®ã€‚
### ä»£ç å—
```typescript
import { Controller, Post, Body } from '@nestjs/common';
import { MonitoringService } from './monitoring.service';

@Controller('monitoring')
export class MonitoringController {
    constructor(private readonly monitoringService: MonitoringService) {}

    @Post()
    async receiveData(@Body() data: any) {
        // å°†æ•°æ®ä¼ é€’ç»™æœåŠ¡å±‚å¤„ç†
        await this.monitoringService.processData(data);
        return { status:'success' };
    }
}
```

##### æ•°æ®å¤„ç†æ¨¡å—
åœ¨æœåŠ¡å±‚ï¼Œæˆ‘ä»¬å¯¹æ¥æ”¶åˆ°çš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå¹¶å°†å…¶æ¨é€è‡³Kafkaã€‚
### ä»£ç å—
```typescript
import { Injectable } from '@nestjs/common';
import { Kafka } from 'kafkajs';

@Injectable()
export class MonitoringService {
    private kafkaProducer;

    constructor() {
        const kafka = new Kafka({
            clientId:'monitoring-service',
            brokers: ['kafka:9092']
        });

        this.kafkaProducer = kafka.producer();
        this.kafkaProducer.connect();
    }

    async processData(data: any) {
        // æ¸…æ´—æ•°æ®æˆ–æ·»åŠ é¢å¤–ä¿¡æ¯
        const enrichedData = {
           ...data,
            receivedAt: new Date().toISOString(),
            environment: process.env.NODE_ENV
        };

        // æ¨é€æ•°æ®åˆ°Kafkaä¸»é¢˜
        await this.kafkaProducer.send({
            topic:'monitoring-events',
            messages: [{ value: JSON.stringify(enrichedData) }]
        });
    }
}
```
åœ¨è¿™ä¸ªæ¨¡å—ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†kafkajsæ¥ä¸Kafkaäº¤äº’ã€‚æ•°æ®åœ¨å¤„ç†åä¼šæ¨é€åˆ°Kafkaä¸»é¢˜monitoring-eventsï¼Œä¾›åç»­çš„æµå¼å¤„ç†æˆ–ç›´æ¥å­˜å‚¨åˆ°ClickHouseã€‚

#### ä¸ClickHouseçš„äº¤äº’
åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦æœåŠ¡ç«¯ç›´æ¥ä¸ClickHouseäº¤äº’ï¼Œæ‰§è¡Œå¤æ‚çš„æŸ¥è¯¢æˆ–æ’å…¥æ“ä½œã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨clickhouse-driverä¸ClickHouseè¿›è¡Œé€šä¿¡ã€‚
### ä»£ç å—
```typescript
import { Injectable } from '@nestjs/common';
import { Client } from 'clickhouse';

@Injectable()
export class ClickhouseService {
    private client;

    constructor() {
        this.client = new Client({
            url: 'http://clickhouse-server:8123',
            basicAuth: {
                username: 'default',
                password: ''
            },
            debug: false
        });
    }

    async insertData(data: any) {
        const query = `
            INSERT INTO monitoring_data (event_type, timestamp, user_id, session_id, device, url, referrer, element_id, x_position, y_position)
            VALUES?
        `;
        await this.client.insert(query, [data]);
    }

    async queryData() {
        const query = `
            SELECT event_type, COUNT(*) AS event_count
            FROM monitoring_data
            WHERE timestamp >= now() - INTERVAL 1 HOUR
            GROUP BY event_type
            ORDER BY event_count DESC
        `;
        return await this.client.query(query).toPromise();
    }
}
```
è¿™ä¸ªæœåŠ¡å¯ä»¥æ ¹æ®éœ€è¦è¢«åµŒå…¥åˆ°ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œå®ç°å¤æ‚çš„æ•°æ®å¤„ç†å’ŒæŸ¥è¯¢ã€‚

### æ•°æ®æµå¤„ç†ä¸åˆ†æ
#### Kafkaæ¶ˆè´¹è€…
åœ¨æ•°æ®è¿›å…¥Kafkaåï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡Kafkaçš„æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­æ‹‰å–æ•°æ®ï¼Œå¹¶å¯¹å…¶è¿›è¡Œå®æ—¶å¤„ç†ã€‚å¯ä»¥ä½¿ç”¨Apache Flinkæˆ–Spark Streamingæ¥å¤„ç†è¿™äº›æ•°æ®ã€‚ 

### ä»£ç å—
```typescript
import { Injectable, OnModuleInit } from '@nestjs/common';
import { Kafka } from 'kafkajs';

@Injectable()
export class KafkaConsumerService implements OnModuleInit {
    private kafkaConsumer;

    constructor() {
        const kafka = new Kafka({
            clientId:'monitoring-consumer',
            brokers: ['kafka:9092']
        });

        this.kafkaConsumer = kafka.consumer({ groupId:'monitoring-group' });
    }

    async onModuleInit() {
        await this.kafkaConsumer.connect();
        await this.kafkaConsumer.subscribe({ topic:'monitoring-events', fromBeginning: true });

        this.kafkaConsumer.run({
            eachMessage: async ({ topic, partition, message }) => {
                const eventData = JSON.parse(message.value.toString());
                // åœ¨è¿™é‡Œå¤„ç†æ•°æ®ï¼Œä¾‹å¦‚æ¨é€åˆ°ClickHouseæˆ–è¿›è¡Œå®æ—¶åˆ†æ
                await this.processEventData(eventData);
            }
        });
    }

    async processEventData(data: any) {
        // åœ¨è¿™é‡Œè¿›è¡Œæ•°æ®çš„æ¸…æ´—ã€èšåˆç­‰å¤„ç†
        console.log(`Processing event: ${data.event_type}`);
        // å°†æ•°æ®æ¨é€åˆ°ClickHouse
        // this.clickhouseService.insertData(data);
    }
}
```

### å‰ç«¯å±•ç¤ºä¸æŠ¥è­¦
#### å®æ—¶ç›‘æ§é¢æ¿
å‰ç«¯å¯ä»¥é€šè¿‡è°ƒç”¨REST APIæˆ–ç›´æ¥æŸ¥è¯¢ClickHouseæ•°æ®åº“ï¼Œè·å–å®æ—¶ç›‘æ§æ•°æ®ï¼Œå¹¶ä½¿ç”¨å›¾è¡¨åº“ï¼ˆå¦‚EChartsï¼‰è¿›è¡Œå¯è§†åŒ–å±•ç¤ºã€‚
### ä»£ç å—
```typescript
import axios from 'axios';
import { useEffect, useState } from'react';

function MonitoringDashboard() {
    const [data, setData] = useState([]);

    useEffect(() => {
        const fetchData = async () => {
            const response = await axios.get('https://your-server.com/api/monitoring/dashboard');
            setData(response.data);
        };

        fetchData();
    }, []);

    return (
        <div>
            {/* ä½¿ç”¨EChartsæˆ–å…¶ä»–å›¾è¡¨åº“å±•ç¤ºæ•°æ® */}
        </div>
    );
}
```

#### æŠ¥è­¦æœºåˆ¶
åœ¨ç³»ç»Ÿä¸­ï¼Œå¯ä»¥æ ¹æ®å®æ—¶ç›‘æ§æ•°æ®è®¾ç½®æŠ¥è­¦è§„åˆ™ï¼Œå½“æŸä¸ªæŒ‡æ ‡è¶…å‡ºé¢„è®¾çš„é˜ˆå€¼æ—¶ï¼Œè§¦å‘æŠ¥è­¦æœºåˆ¶ï¼ˆå¦‚å‘é€é‚®ä»¶æˆ–æ¶ˆæ¯é€šçŸ¥ï¼‰ã€‚
### ä»£ç å—
```typescript
// å®šæœŸä»»åŠ¡æˆ–å®æ—¶æ£€æµ‹
function checkForAlerts(data) {
    if (data.errorCount > 100) {
        sendAlert('High error rate detected!');
    }
}

function sendAlert(message) {
    axios.post('https://alert-service.com/api/send', {
        message,
        recipients: ['admin@example.com']
    });
}
``` 