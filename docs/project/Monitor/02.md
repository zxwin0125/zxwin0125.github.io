👍 重难点：
1. 全栈项目架构
2. Kafka + Clickhouse + Flink 实时数据流经典架构设计
3. 性能与异常指标采集

- 【初中级】做过监控设计？那性能与异常监控指标怎么算的？
- 【中高级】有设计过大型实时数据流相关系统吗，具体怎么做？
- 【专家级】详细说明监控平台方案设计与落地，项目实践

### 【初中级】做过监控设计？那前端性能与异常监控指标怎么算？
性能监控那节，我们详细介绍了性能优化相关指标概念，这次我们来结合大厂监控平台实战，充分理解指标定义、计算与上报逻辑。

前端性能监控通过收集和分析用户端的性能数据来衡量和优化页面加载速度、交互响应时间等关键性能指标的过程。

### 为什么需要性能监控？
- 提升用户体验：减少页面加载和响应时间，提高用户留存率。
- 发现和优化性能瓶颈：及时发现影响性能的因素并进行优化。
- 数据驱动决策：基于真实数据进行性能优化，而非依赖直觉。

### 常见的性能监控指标
#### 页面加载时间（Page Load Time）
- 定义：从用户发出请求到页面完全加载完成的时间。
- 计算方式：
### 代码块
```javascript
const pageLoadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
```
- 意义：页面加载时间是用户体验的核心指标之一。

#### 首次内容绘制时间（First Contentful Paint, FCP）
- 定义：页面首次绘制出任何内容的时间。
- 获取方法：
### 代码块
```javascript
new PerformanceObserver((entryList) => {
    const entries = entryList.getEntriesByName('first-contentful-paint');
    if (entries.length > 0) {
        const fcpTime = entries[0].startTime;
        console.log(`FCP: ${fcpTime}`);
    }
}).observe({ type: 'paint', buffered: true });
```
- 意义：FCP直接反映页面开始展现内容的速度。

#### 最大内容绘制时间（Largest Contentful Paint, LCP）
- 定义：页面中最大内容元素的渲染时间。
- 获取方法：
### 代码块
```javascript
new PerformanceObserver((entryList) => {
    const entries = entryList.getEntries();
    const lastEntry = entries[entries.length - 1];
    const lcpTime = lastEntry.startTime;
    console.log(`LCP: ${lcpTime}`);
}).observe({ type: 'largest-contentful-paint', buffered: true });
```
- 意义：LCP是衡量页面主要内容是否迅速加载的核心指标。 
  
#### 交互时间（Time to Interactive, TTI）
- 定义：页面从加载开始到可以响应用户交互的时间。
- 计算方式：
### 代码块
```javascript
const timeToInteractive = performance.timing.domInteractive - performance.timing.navigationStart;
```
- 意义：TTI直接关系到用户能够开始操作页面的时间。

#### 资源加载时间
- 定义：每个静态资源（如图片、JS文件）的加载时间。
- 获取方法：
### 代码块
```javascript
const resources = performance.getEntriesByType('resource');
resources.forEach((resource) => {
    const loadTime = resource.responseEnd - resource.startTime;
    console.log(`${resource.name}: ${loadTime}`);
});
```
- 意义：资源加载时间影响整体页面加载性能，是优化的关键。

### 前端异常监控
前端异常监控指的是捕获并报告用户端发生的错误或异常，帮助开发者及时发现和修复问题。最经典的要数sentry了，有兴趣的同学呢，重点了解sentry的源码实现。

#### JavaScript错误（JS Errors）
- 定义：运行时JavaScript错误。
- 捕获方法：
### 代码块
```javascript
window.onerror = function (message, source, lineno, colno, error) {
    console.log(`Error: ${message}, Source: ${source}, Line: ${lineno}, Column: ${colno}, Error Object: ${error}`);
};
``` 

#### Promise未处理拒绝（Unhandled Promise Rejection）
- 定义：未处理的Promise拒绝错误。
- 捕获方法：
### 代码块
```javascript
window.addEventListener('unhandledrejection', function (event) {
    console.log(`Unhandled Rejection: ${event.reason}`);
});
```

#### 资源加载错误
- 定义：静态资源加载失败错误。
- 捕获方法：
### 代码块
```javascript
window.addEventListener('error', function (event) {
    if (event.target!== window) {
        console.log(`Resource Load Error: ${event.target.src || event.target.href}`);
    }
}, true);
```

#### 接口请求失败（API Failure）
- 定义：API请求失败或超时错误。
- 捕获方法：
### 代码块
```javascript
fetch(url)
   .then(response => {
        if (!response.ok) {
            console.error(`API Failure: ${response.status} ${response.statusText}`);
        }
    })
   .catch(error => console.error(`Fetch Error: ${error}`));
```

### 统一上报数据格式
#### 数据格式设计原则
- 一致性：所有监控数据应采用统一的格式，便于后续分析和展示。
- 可扩展性：数据格式设计应考虑未来的扩展需求，允许添加新字段。
- 轻量化：数据尽量精简，减少上报带来的性能影响。 

### 数据格式示例
以下为一个仿照Sentry定义的统一性能与异常监控数据格式：
### 代码块
```json
{
    "event_id": "unique-event-id",
    "timestamp": "2024-08-28T14:25:43.511Z",
    "platform": "javascript",
    "release": "project-release-version",
    "environment": "production",
    "user": {
        "id": "user-id",
        "username": "username",
        "email": "user@example.com",
        "ip_address": "user-ip-address"
    },
    "contexts": {
        "performance": {
            "page_load_time": 1234,
            "fcp": 678,
            "lcp": 1234,
            "tti": 2345,
            "resources": [
                {"name": "resource1.js", "load_time": 123},
                {"name": "image1.png", "load_time": 456}
            ]
        }
    },
    "exception": {
        "values": [
            {
                "type": "TypeError",
                "value": "Cannot read property 'x' of undefined",
                "stacktrace": {
                    "frames": [
                        {
                            "filename": "https://example.com/script.js",
                            "lineno": 42,
                            "colno": 21,
                            "function": "myFunction",
                            "in_app": true
                        }
                    ]
                }
            }
        ]
    },
    "errors": [
        {
            "message": "Unhandled Promise Rejection: Error: Something went wrong",
            "source": "https://example.com/promise.js",
            "lineno": 10,
            "colno": 15,
            "errorObject": {
                "name": "Error",
                "message": "Something went wrong",
                "stack": "Error: Something went wrong\n at promise.js:10:15"
            }
        },
        {
            "message": "Resource Load Error: https://example.com/image.png",
            "source": "image.png",
            "lineno": 0,
            "colno": 0
        }
    ],
    "breadcrumbs": [
        {
            "category": "ui.click",
            "message": "User clicked button",
            "level": "info",
            "timestamp": "2024-08-28T14:25:40.511Z"
        },
        {
            "category": "navigation",
            "message": "User navigated to /dashboard",
            "level": "info",
            "timestamp": "2024-08-28T14:25:43.511Z"
        }
    ]
}
``` 

### 数据上报
使用以下代码上报监控数据：
#### fetch
### 代码块
```javascript
fetch('https://your-monitoring-service.com/api/events', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer your-api-key'
    },
    body: JSON.stringify(eventData) // eventData 是 JSON 数据
});
```

除此以外，还有以下上报方式：
- ajax
- 图片打点image
- navigator.sendBeacon
- WS

### 【拓展】用户行为埋点与监控
埋点是一种通过在前端代码中添加特定标记或逻辑来记录用户行为、页面事件等数据的技术。埋点数据可以帮助开发者了解用户行为路径、页面功能使用情况等，为产品优化和用户体验提升提供数据支持。

### 常见埋点指标
1. **页面浏览量（Page View, PV）**
    - 定义：用户每次加载页面时的计数。
    - 埋点方式：在页面加载时触发埋点。
### 代码块
```javascript
// Example: 埋点触发
sendTrackingData({
    event: 'page_view',
    url: window.location.href,
    timestamp: Date.now()
});
```
2. **独立访客数（Unique Visitor, UV）**
    - 定义：独立用户访问次数的计数。通常通过用户ID或Cookie进行识别。
    - 埋点方式：在用户第一次访问时触发埋点。
### 代码块
```javascript
// Example: 获取用户ID并触发UV埋点
const userId = getUserIdFromCookie();
if (!userId) {
    setUserIdInCookie(generateNewUserId());
}
sendTrackingData({
    event: 'unique_visitor',
    userId: userId,
    timestamp: Date.now()
});
```
3. **点击事件（Click Event）**
    - 定义：用户点击页面元素（如按钮、链接）时的记录。
    - 埋点方式：在用户点击特定元素时触发埋点。
### 代码块
```javascript
document.getElementById('buttonId').addEventListener('click', function() {
    sendTrackingData({
        event: 'click',
        elementId: 'buttonId',
        url: window.location.href,
        timestamp: Date.now()
    });
});
```
4. **表单提交（Form Submit）**
    - 定义：用户提交表单时的记录。
    - 埋点方式：在表单提交时触发埋点。
### 代码块
```javascript
document.getElementById('formId').addEventListener('submit', function() {
    sendTrackingData({
        event: 'form_submit',
        formId: 'formId',
        url: window.location.href,
        timestamp: Date.now()
    });
});
```
5. **停留时间（Time on Page）**
    - 定义：用户在页面上停留的时间。
    - 埋点方式：在页面加载和关闭时分别触发埋点，并计算时间差。
### 代码块
```javascript
const startTime = Date.now();
window.addEventListener('beforeunload', function() {
    const timeSpent = Date.now() - startTime;
    sendTrackingData({
        event: 'time_on_page',
        timeSpent: timeSpent,
        url: window.location.href,
        timestamp: Date.now()
    });
});
``` 

### 综合埋点数据协议设计
在之前的性能与异常监控数据格式的基础上，我们可以加入埋点数据，使数据协议更加完整和灵活。以下是包含埋点信息的综合数据协议设计：
### 代码块
```json
{
    "event_id": "unique-event-id",
    "timestamp": "2024-08-28T14:25:43.511Z",
    "platform": "javascript",
    "release": "project-release-version",
    "environment": "production",
    "user": {
        "id": "user-id",
        "username": "username",
        "email": "user@example.com",
        "ip_address": "user-ip-address"
    },
    "contexts": {
        "performance": {
            "page_load_time": 1234,
            "fcp": 678,
            "lcp": 1234,
            "tti": 2345,
            "resources": [
                {"name": "resource1.js", "load_time": 123},
                {"name": "image1.png", "load_time": 456}
            ]
        },
        "exceptions": {
            "values": [
                {
                    "type": "TypeError",
                    "value": "Cannot read property 'x' of undefined",
                    "stacktrace": {
                        "frames": [
                            {
                                "filename": "https://example.com/script.js",
                                "lineno": 42,
                                "colno": 21,
                                "function": "myFunction",
                                "in_app": true
                            }
                        ]
                    }
                }
            ]
        }
    },
    "tracking": {
        "events": [
            {
                "event": "page_view",
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:25:43.511Z"
            },
            {
                "event": "click",
                "elementId": "buttonId",
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:26:00.511Z"
            },
            {
                "event": "form_submit",
                "formId": "formId",
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:26:30.511Z"
            },
            {
                "event": "time_on_page",
                "timeSpent": 120000,
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:28:00.511Z"
            }
        ]
    },
    "errors": [
        {
            "message": "Unhandled Promise Rejection: Error: Something went wrong",
            "source": "https://example.com/promise.js",
            "lineno": 10,
            "colno": 15,
            "errorObject": {
                "name": "Error",
                "message": "Something went wrong",
                "stack": "Error: Something went wrong\n at promise.js:10:15"
            }
        },
        {
            "message": "Resource Load Error: https://example.com/image.png",
            "source": "image.png",
            "lineno": 0,
            "colno": 0
        }
    ],
    "breadcrumbs": [
        {
            "category": "ui.click",
            "message": "User clicked button",
            "level": "info",
            "timestamp": "2024-08-28T14:25:40.511Z"
        },
        {
            "category": "navigation",
            "message": "User navigated to /dashboard",
            "level": "info",
            "timestamp": "2024-08-28T14:25:43.511Z"
        }
    ]
}
``` 
