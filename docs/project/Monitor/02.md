ğŸ‘ é‡éš¾ç‚¹ï¼š
1. å…¨æ ˆé¡¹ç›®æ¶æ„
2. Kafka + Clickhouse + Flink å®æ—¶æ•°æ®æµç»å…¸æ¶æ„è®¾è®¡
3. æ€§èƒ½ä¸å¼‚å¸¸æŒ‡æ ‡é‡‡é›†

- ã€åˆä¸­çº§ã€‘åšè¿‡ç›‘æ§è®¾è®¡ï¼Ÿé‚£æ€§èƒ½ä¸å¼‚å¸¸ç›‘æ§æŒ‡æ ‡æ€ä¹ˆç®—çš„ï¼Ÿ
- ã€ä¸­é«˜çº§ã€‘æœ‰è®¾è®¡è¿‡å¤§å‹å®æ—¶æ•°æ®æµç›¸å…³ç³»ç»Ÿå—ï¼Œå…·ä½“æ€ä¹ˆåšï¼Ÿ
- ã€ä¸“å®¶çº§ã€‘è¯¦ç»†è¯´æ˜ç›‘æ§å¹³å°æ–¹æ¡ˆè®¾è®¡ä¸è½åœ°ï¼Œé¡¹ç›®å®è·µ

### ã€åˆä¸­çº§ã€‘åšè¿‡ç›‘æ§è®¾è®¡ï¼Ÿé‚£å‰ç«¯æ€§èƒ½ä¸å¼‚å¸¸ç›‘æ§æŒ‡æ ‡æ€ä¹ˆç®—ï¼Ÿ
æ€§èƒ½ç›‘æ§é‚£èŠ‚ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº†æ€§èƒ½ä¼˜åŒ–ç›¸å…³æŒ‡æ ‡æ¦‚å¿µï¼Œè¿™æ¬¡æˆ‘ä»¬æ¥ç»“åˆå¤§å‚ç›‘æ§å¹³å°å®æˆ˜ï¼Œå……åˆ†ç†è§£æŒ‡æ ‡å®šä¹‰ã€è®¡ç®—ä¸ä¸ŠæŠ¥é€»è¾‘ã€‚

å‰ç«¯æ€§èƒ½ç›‘æ§é€šè¿‡æ”¶é›†å’Œåˆ†æç”¨æˆ·ç«¯çš„æ€§èƒ½æ•°æ®æ¥è¡¡é‡å’Œä¼˜åŒ–é¡µé¢åŠ è½½é€Ÿåº¦ã€äº¤äº’å“åº”æ—¶é—´ç­‰å…³é”®æ€§èƒ½æŒ‡æ ‡çš„è¿‡ç¨‹ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦æ€§èƒ½ç›‘æ§ï¼Ÿ
- æå‡ç”¨æˆ·ä½“éªŒï¼šå‡å°‘é¡µé¢åŠ è½½å’Œå“åº”æ—¶é—´ï¼Œæé«˜ç”¨æˆ·ç•™å­˜ç‡ã€‚
- å‘ç°å’Œä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆï¼šåŠæ—¶å‘ç°å½±å“æ€§èƒ½çš„å› ç´ å¹¶è¿›è¡Œä¼˜åŒ–ã€‚
- æ•°æ®é©±åŠ¨å†³ç­–ï¼šåŸºäºçœŸå®æ•°æ®è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œè€Œéä¾èµ–ç›´è§‰ã€‚

### å¸¸è§çš„æ€§èƒ½ç›‘æ§æŒ‡æ ‡
#### é¡µé¢åŠ è½½æ—¶é—´ï¼ˆPage Load Timeï¼‰
- å®šä¹‰ï¼šä»ç”¨æˆ·å‘å‡ºè¯·æ±‚åˆ°é¡µé¢å®Œå…¨åŠ è½½å®Œæˆçš„æ—¶é—´ã€‚
- è®¡ç®—æ–¹å¼ï¼š
### ä»£ç å—
```javascript
const pageLoadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
```
- æ„ä¹‰ï¼šé¡µé¢åŠ è½½æ—¶é—´æ˜¯ç”¨æˆ·ä½“éªŒçš„æ ¸å¿ƒæŒ‡æ ‡ä¹‹ä¸€ã€‚

#### é¦–æ¬¡å†…å®¹ç»˜åˆ¶æ—¶é—´ï¼ˆFirst Contentful Paint, FCPï¼‰
- å®šä¹‰ï¼šé¡µé¢é¦–æ¬¡ç»˜åˆ¶å‡ºä»»ä½•å†…å®¹çš„æ—¶é—´ã€‚
- è·å–æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
new PerformanceObserver((entryList) => {
    const entries = entryList.getEntriesByName('first-contentful-paint');
    if (entries.length > 0) {
        const fcpTime = entries[0].startTime;
        console.log(`FCP: ${fcpTime}`);
    }
}).observe({ type: 'paint', buffered: true });
```
- æ„ä¹‰ï¼šFCPç›´æ¥åæ˜ é¡µé¢å¼€å§‹å±•ç°å†…å®¹çš„é€Ÿåº¦ã€‚

#### æœ€å¤§å†…å®¹ç»˜åˆ¶æ—¶é—´ï¼ˆLargest Contentful Paint, LCPï¼‰
- å®šä¹‰ï¼šé¡µé¢ä¸­æœ€å¤§å†…å®¹å…ƒç´ çš„æ¸²æŸ“æ—¶é—´ã€‚
- è·å–æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
new PerformanceObserver((entryList) => {
    const entries = entryList.getEntries();
    const lastEntry = entries[entries.length - 1];
    const lcpTime = lastEntry.startTime;
    console.log(`LCP: ${lcpTime}`);
}).observe({ type: 'largest-contentful-paint', buffered: true });
```
- æ„ä¹‰ï¼šLCPæ˜¯è¡¡é‡é¡µé¢ä¸»è¦å†…å®¹æ˜¯å¦è¿…é€ŸåŠ è½½çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚ 
  
#### äº¤äº’æ—¶é—´ï¼ˆTime to Interactive, TTIï¼‰
- å®šä¹‰ï¼šé¡µé¢ä»åŠ è½½å¼€å§‹åˆ°å¯ä»¥å“åº”ç”¨æˆ·äº¤äº’çš„æ—¶é—´ã€‚
- è®¡ç®—æ–¹å¼ï¼š
### ä»£ç å—
```javascript
const timeToInteractive = performance.timing.domInteractive - performance.timing.navigationStart;
```
- æ„ä¹‰ï¼šTTIç›´æ¥å…³ç³»åˆ°ç”¨æˆ·èƒ½å¤Ÿå¼€å§‹æ“ä½œé¡µé¢çš„æ—¶é—´ã€‚

#### èµ„æºåŠ è½½æ—¶é—´
- å®šä¹‰ï¼šæ¯ä¸ªé™æ€èµ„æºï¼ˆå¦‚å›¾ç‰‡ã€JSæ–‡ä»¶ï¼‰çš„åŠ è½½æ—¶é—´ã€‚
- è·å–æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
const resources = performance.getEntriesByType('resource');
resources.forEach((resource) => {
    const loadTime = resource.responseEnd - resource.startTime;
    console.log(`${resource.name}: ${loadTime}`);
});
```
- æ„ä¹‰ï¼šèµ„æºåŠ è½½æ—¶é—´å½±å“æ•´ä½“é¡µé¢åŠ è½½æ€§èƒ½ï¼Œæ˜¯ä¼˜åŒ–çš„å…³é”®ã€‚

### å‰ç«¯å¼‚å¸¸ç›‘æ§
å‰ç«¯å¼‚å¸¸ç›‘æ§æŒ‡çš„æ˜¯æ•è·å¹¶æŠ¥å‘Šç”¨æˆ·ç«¯å‘ç”Ÿçš„é”™è¯¯æˆ–å¼‚å¸¸ï¼Œå¸®åŠ©å¼€å‘è€…åŠæ—¶å‘ç°å’Œä¿®å¤é—®é¢˜ã€‚æœ€ç»å…¸çš„è¦æ•°sentryäº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å‘¢ï¼Œé‡ç‚¹äº†è§£sentryçš„æºç å®ç°ã€‚

#### JavaScripté”™è¯¯ï¼ˆJS Errorsï¼‰
- å®šä¹‰ï¼šè¿è¡Œæ—¶JavaScripté”™è¯¯ã€‚
- æ•è·æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
window.onerror = function (message, source, lineno, colno, error) {
    console.log(`Error: ${message}, Source: ${source}, Line: ${lineno}, Column: ${colno}, Error Object: ${error}`);
};
``` 

#### Promiseæœªå¤„ç†æ‹’ç»ï¼ˆUnhandled Promise Rejectionï¼‰
- å®šä¹‰ï¼šæœªå¤„ç†çš„Promiseæ‹’ç»é”™è¯¯ã€‚
- æ•è·æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
window.addEventListener('unhandledrejection', function (event) {
    console.log(`Unhandled Rejection: ${event.reason}`);
});
```

#### èµ„æºåŠ è½½é”™è¯¯
- å®šä¹‰ï¼šé™æ€èµ„æºåŠ è½½å¤±è´¥é”™è¯¯ã€‚
- æ•è·æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
window.addEventListener('error', function (event) {
    if (event.target!== window) {
        console.log(`Resource Load Error: ${event.target.src || event.target.href}`);
    }
}, true);
```

#### æ¥å£è¯·æ±‚å¤±è´¥ï¼ˆAPI Failureï¼‰
- å®šä¹‰ï¼šAPIè¯·æ±‚å¤±è´¥æˆ–è¶…æ—¶é”™è¯¯ã€‚
- æ•è·æ–¹æ³•ï¼š
### ä»£ç å—
```javascript
fetch(url)
   .then(response => {
        if (!response.ok) {
            console.error(`API Failure: ${response.status} ${response.statusText}`);
        }
    })
   .catch(error => console.error(`Fetch Error: ${error}`));
```

### ç»Ÿä¸€ä¸ŠæŠ¥æ•°æ®æ ¼å¼
#### æ•°æ®æ ¼å¼è®¾è®¡åŸåˆ™
- ä¸€è‡´æ€§ï¼šæ‰€æœ‰ç›‘æ§æ•°æ®åº”é‡‡ç”¨ç»Ÿä¸€çš„æ ¼å¼ï¼Œä¾¿äºåç»­åˆ†æå’Œå±•ç¤ºã€‚
- å¯æ‰©å±•æ€§ï¼šæ•°æ®æ ¼å¼è®¾è®¡åº”è€ƒè™‘æœªæ¥çš„æ‰©å±•éœ€æ±‚ï¼Œå…è®¸æ·»åŠ æ–°å­—æ®µã€‚
- è½»é‡åŒ–ï¼šæ•°æ®å°½é‡ç²¾ç®€ï¼Œå‡å°‘ä¸ŠæŠ¥å¸¦æ¥çš„æ€§èƒ½å½±å“ã€‚ 

### æ•°æ®æ ¼å¼ç¤ºä¾‹
ä»¥ä¸‹ä¸ºä¸€ä¸ªä»¿ç…§Sentryå®šä¹‰çš„ç»Ÿä¸€æ€§èƒ½ä¸å¼‚å¸¸ç›‘æ§æ•°æ®æ ¼å¼ï¼š
### ä»£ç å—
```json
{
    "event_id": "unique-event-id",
    "timestamp": "2024-08-28T14:25:43.511Z",
    "platform": "javascript",
    "release": "project-release-version",
    "environment": "production",
    "user": {
        "id": "user-id",
        "username": "username",
        "email": "user@example.com",
        "ip_address": "user-ip-address"
    },
    "contexts": {
        "performance": {
            "page_load_time": 1234,
            "fcp": 678,
            "lcp": 1234,
            "tti": 2345,
            "resources": [
                {"name": "resource1.js", "load_time": 123},
                {"name": "image1.png", "load_time": 456}
            ]
        }
    },
    "exception": {
        "values": [
            {
                "type": "TypeError",
                "value": "Cannot read property 'x' of undefined",
                "stacktrace": {
                    "frames": [
                        {
                            "filename": "https://example.com/script.js",
                            "lineno": 42,
                            "colno": 21,
                            "function": "myFunction",
                            "in_app": true
                        }
                    ]
                }
            }
        ]
    },
    "errors": [
        {
            "message": "Unhandled Promise Rejection: Error: Something went wrong",
            "source": "https://example.com/promise.js",
            "lineno": 10,
            "colno": 15,
            "errorObject": {
                "name": "Error",
                "message": "Something went wrong",
                "stack": "Error: Something went wrong\n at promise.js:10:15"
            }
        },
        {
            "message": "Resource Load Error: https://example.com/image.png",
            "source": "image.png",
            "lineno": 0,
            "colno": 0
        }
    ],
    "breadcrumbs": [
        {
            "category": "ui.click",
            "message": "User clicked button",
            "level": "info",
            "timestamp": "2024-08-28T14:25:40.511Z"
        },
        {
            "category": "navigation",
            "message": "User navigated to /dashboard",
            "level": "info",
            "timestamp": "2024-08-28T14:25:43.511Z"
        }
    ]
}
``` 

### æ•°æ®ä¸ŠæŠ¥
ä½¿ç”¨ä»¥ä¸‹ä»£ç ä¸ŠæŠ¥ç›‘æ§æ•°æ®ï¼š
#### fetch
### ä»£ç å—
```javascript
fetch('https://your-monitoring-service.com/api/events', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer your-api-key'
    },
    body: JSON.stringify(eventData) // eventData æ˜¯ JSON æ•°æ®
});
```

é™¤æ­¤ä»¥å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹ä¸ŠæŠ¥æ–¹å¼ï¼š
- ajax
- å›¾ç‰‡æ‰“ç‚¹image
- navigator.sendBeacon
- WS

### ã€æ‹“å±•ã€‘ç”¨æˆ·è¡Œä¸ºåŸ‹ç‚¹ä¸ç›‘æ§
åŸ‹ç‚¹æ˜¯ä¸€ç§é€šè¿‡åœ¨å‰ç«¯ä»£ç ä¸­æ·»åŠ ç‰¹å®šæ ‡è®°æˆ–é€»è¾‘æ¥è®°å½•ç”¨æˆ·è¡Œä¸ºã€é¡µé¢äº‹ä»¶ç­‰æ•°æ®çš„æŠ€æœ¯ã€‚åŸ‹ç‚¹æ•°æ®å¯ä»¥å¸®åŠ©å¼€å‘è€…äº†è§£ç”¨æˆ·è¡Œä¸ºè·¯å¾„ã€é¡µé¢åŠŸèƒ½ä½¿ç”¨æƒ…å†µç­‰ï¼Œä¸ºäº§å“ä¼˜åŒ–å’Œç”¨æˆ·ä½“éªŒæå‡æä¾›æ•°æ®æ”¯æŒã€‚

### å¸¸è§åŸ‹ç‚¹æŒ‡æ ‡
1. **é¡µé¢æµè§ˆé‡ï¼ˆPage View, PVï¼‰**
    - å®šä¹‰ï¼šç”¨æˆ·æ¯æ¬¡åŠ è½½é¡µé¢æ—¶çš„è®¡æ•°ã€‚
    - åŸ‹ç‚¹æ–¹å¼ï¼šåœ¨é¡µé¢åŠ è½½æ—¶è§¦å‘åŸ‹ç‚¹ã€‚
### ä»£ç å—
```javascript
// Example: åŸ‹ç‚¹è§¦å‘
sendTrackingData({
    event: 'page_view',
    url: window.location.href,
    timestamp: Date.now()
});
```
2. **ç‹¬ç«‹è®¿å®¢æ•°ï¼ˆUnique Visitor, UVï¼‰**
    - å®šä¹‰ï¼šç‹¬ç«‹ç”¨æˆ·è®¿é—®æ¬¡æ•°çš„è®¡æ•°ã€‚é€šå¸¸é€šè¿‡ç”¨æˆ·IDæˆ–Cookieè¿›è¡Œè¯†åˆ«ã€‚
    - åŸ‹ç‚¹æ–¹å¼ï¼šåœ¨ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ—¶è§¦å‘åŸ‹ç‚¹ã€‚
### ä»£ç å—
```javascript
// Example: è·å–ç”¨æˆ·IDå¹¶è§¦å‘UVåŸ‹ç‚¹
const userId = getUserIdFromCookie();
if (!userId) {
    setUserIdInCookie(generateNewUserId());
}
sendTrackingData({
    event: 'unique_visitor',
    userId: userId,
    timestamp: Date.now()
});
```
3. **ç‚¹å‡»äº‹ä»¶ï¼ˆClick Eventï¼‰**
    - å®šä¹‰ï¼šç”¨æˆ·ç‚¹å‡»é¡µé¢å…ƒç´ ï¼ˆå¦‚æŒ‰é’®ã€é“¾æ¥ï¼‰æ—¶çš„è®°å½•ã€‚
    - åŸ‹ç‚¹æ–¹å¼ï¼šåœ¨ç”¨æˆ·ç‚¹å‡»ç‰¹å®šå…ƒç´ æ—¶è§¦å‘åŸ‹ç‚¹ã€‚
### ä»£ç å—
```javascript
document.getElementById('buttonId').addEventListener('click', function() {
    sendTrackingData({
        event: 'click',
        elementId: 'buttonId',
        url: window.location.href,
        timestamp: Date.now()
    });
});
```
4. **è¡¨å•æäº¤ï¼ˆForm Submitï¼‰**
    - å®šä¹‰ï¼šç”¨æˆ·æäº¤è¡¨å•æ—¶çš„è®°å½•ã€‚
    - åŸ‹ç‚¹æ–¹å¼ï¼šåœ¨è¡¨å•æäº¤æ—¶è§¦å‘åŸ‹ç‚¹ã€‚
### ä»£ç å—
```javascript
document.getElementById('formId').addEventListener('submit', function() {
    sendTrackingData({
        event: 'form_submit',
        formId: 'formId',
        url: window.location.href,
        timestamp: Date.now()
    });
});
```
5. **åœç•™æ—¶é—´ï¼ˆTime on Pageï¼‰**
    - å®šä¹‰ï¼šç”¨æˆ·åœ¨é¡µé¢ä¸Šåœç•™çš„æ—¶é—´ã€‚
    - åŸ‹ç‚¹æ–¹å¼ï¼šåœ¨é¡µé¢åŠ è½½å’Œå…³é—­æ—¶åˆ†åˆ«è§¦å‘åŸ‹ç‚¹ï¼Œå¹¶è®¡ç®—æ—¶é—´å·®ã€‚
### ä»£ç å—
```javascript
const startTime = Date.now();
window.addEventListener('beforeunload', function() {
    const timeSpent = Date.now() - startTime;
    sendTrackingData({
        event: 'time_on_page',
        timeSpent: timeSpent,
        url: window.location.href,
        timestamp: Date.now()
    });
});
``` 

### ç»¼åˆåŸ‹ç‚¹æ•°æ®åè®®è®¾è®¡
åœ¨ä¹‹å‰çš„æ€§èƒ½ä¸å¼‚å¸¸ç›‘æ§æ•°æ®æ ¼å¼çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åŠ å…¥åŸ‹ç‚¹æ•°æ®ï¼Œä½¿æ•°æ®åè®®æ›´åŠ å®Œæ•´å’Œçµæ´»ã€‚ä»¥ä¸‹æ˜¯åŒ…å«åŸ‹ç‚¹ä¿¡æ¯çš„ç»¼åˆæ•°æ®åè®®è®¾è®¡ï¼š
### ä»£ç å—
```json
{
    "event_id": "unique-event-id",
    "timestamp": "2024-08-28T14:25:43.511Z",
    "platform": "javascript",
    "release": "project-release-version",
    "environment": "production",
    "user": {
        "id": "user-id",
        "username": "username",
        "email": "user@example.com",
        "ip_address": "user-ip-address"
    },
    "contexts": {
        "performance": {
            "page_load_time": 1234,
            "fcp": 678,
            "lcp": 1234,
            "tti": 2345,
            "resources": [
                {"name": "resource1.js", "load_time": 123},
                {"name": "image1.png", "load_time": 456}
            ]
        },
        "exceptions": {
            "values": [
                {
                    "type": "TypeError",
                    "value": "Cannot read property 'x' of undefined",
                    "stacktrace": {
                        "frames": [
                            {
                                "filename": "https://example.com/script.js",
                                "lineno": 42,
                                "colno": 21,
                                "function": "myFunction",
                                "in_app": true
                            }
                        ]
                    }
                }
            ]
        }
    },
    "tracking": {
        "events": [
            {
                "event": "page_view",
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:25:43.511Z"
            },
            {
                "event": "click",
                "elementId": "buttonId",
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:26:00.511Z"
            },
            {
                "event": "form_submit",
                "formId": "formId",
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:26:30.511Z"
            },
            {
                "event": "time_on_page",
                "timeSpent": 120000,
                "url": "https://example.com",
                "timestamp": "2024-08-28T14:28:00.511Z"
            }
        ]
    },
    "errors": [
        {
            "message": "Unhandled Promise Rejection: Error: Something went wrong",
            "source": "https://example.com/promise.js",
            "lineno": 10,
            "colno": 15,
            "errorObject": {
                "name": "Error",
                "message": "Something went wrong",
                "stack": "Error: Something went wrong\n at promise.js:10:15"
            }
        },
        {
            "message": "Resource Load Error: https://example.com/image.png",
            "source": "image.png",
            "lineno": 0,
            "colno": 0
        }
    ],
    "breadcrumbs": [
        {
            "category": "ui.click",
            "message": "User clicked button",
            "level": "info",
            "timestamp": "2024-08-28T14:25:40.511Z"
        },
        {
            "category": "navigation",
            "message": "User navigated to /dashboard",
            "level": "info",
            "timestamp": "2024-08-28T14:25:43.511Z"
        }
    ]
}
``` 
